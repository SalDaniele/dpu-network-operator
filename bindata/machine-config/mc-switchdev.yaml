apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: offload
  name: 00-bluefield-switchdev
spec:
  config:
    ignition:
      version: 3.1.0
    storage:
      files:
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKc2V0IC1ldXgKaW5wdXQ9Ii9ldGMvc3Jpb3ZfY29uZmlnLmpzb24iClVERVZfUlVMRV9GSUxFPScvZXRjL3VkZXYvcnVsZXMuZC8xMC1wZXJzaXN0ZW50LW5ldC5ydWxlcycKCmlmIFsgISAtZiAkaW5wdXQgXTsgdGhlbgogIGVjaG8gIkZpbGUgL2V0Yy9zcmlvdl9jb25maWcuanNvbiBub3QgZXhpc3QuIgogIGV4aXQKZmkKCmFwcGVuZF90b19maWxlKCl7CiAgY29udGVudD0iJDEiCiAgZmlsZV9uYW1lPSIkMiIKICBpZiAhIHRlc3QgLWYgIiRmaWxlX25hbWUiCiAgdGhlbgogICAgZWNobyAiJGNvbnRlbnQiID4gIiRmaWxlX25hbWUiCiAgZWxzZQogICAgaWYgISBncmVwIC1GeHEgIiRjb250ZW50IiAiJGZpbGVfbmFtZSIKICAgIHRoZW4KICAgICAgZWNobyAiJGNvbnRlbnQiID4+ICIkZmlsZV9uYW1lIgogICAgZmkKICBmaQp9CgphZGRfdWRldl9ydWxlX2Zvcl9zcmlvdl9wZigpewogICAgcGZfcGNpPSQoZ3JlcCBQQ0lfU0xPVF9OQU1FIC9zeXMvY2xhc3MvbmV0LyQxL2RldmljZS91ZXZlbnQgfCBjdXQgLWQnPScgLWYyKQogICAgdWRldl9kYXRhX2xpbmU9IlNVQlNZU1RFTT09XCJuZXRcIiwgQUNUSU9OPT1cImFkZFwiLCBEUklWRVJTPT1cIj8qXCIsIEtFUk5FTFM9PVwiJHBmX3BjaVwiLCBOQU1FPVwiJDFcIiIKICAgIGFwcGVuZF90b19maWxlICIkdWRldl9kYXRhX2xpbmUiICIkVURFVl9SVUxFX0ZJTEUiCn0KCmpxIC1jICcuaW50ZXJmYWNlc1tdJyAkaW5wdXQgfCB3aGlsZSByZWFkIGlmYWNlOwpkbwogIGVzd2l0Y2hfbW9kZT0kKGVjaG8gJGlmYWNlIHwganEgJy5lU3dpdGNoTW9kZScgLXIpCiAgaWYgW1sgIiRlc3dpdGNoX21vZGUiID09ICJzd2l0Y2hkZXYiIF1dOyB0aGVuCiAgICBwY2lfYWRkcj0kKGVjaG8gJGlmYWNlIHwganEgJy5wY2lBZGRyZXNzJyAtcikKICAgIG5hbWU9JChlY2hvICRpZmFjZSB8IGpxICcubmFtZScgLXIpCgogICAgIyBDcmVhdGUgdWRldiBydWxlIHRvIHNhdmUgUEYgbmFtZQogICAgIyBhZGRfdWRldl9ydWxlX2Zvcl9zcmlvdl9wZiAkbmFtZQoKICAgIHNsZWVwIDUKCiAgICAjIHNldCBQRiB0byBzd2l0Y2hkZXYgbW9kZQogICAgZGV2bGluayBkZXYgZXN3aXRjaCBzZXQgcGNpLyR7cGNpX2FkZHJ9IG1vZGUgc3dpdGNoZGV2CiAgICAjIGlwIGxpbmsgc2V0ICR7bmFtZX0gdXAKCiAgICAjIHR1cm4gaHctdGMtb2ZmbG9hZCBvbgogICAgIyAvdXNyL3NiaW4vZXRodG9vbCAtSyAke25hbWV9IGh3LXRjLW9mZmxvYWQgb24KICBmaQpkb25lCg==
        mode: 0755
        overwrite: true
        path: /usr/local/bin/configure-switchdev.sh
      - contents:
          source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKClNXSUQ9JDIKIyBtaWdodCBiZSBwZjB2ZjEgc28gb25seSBnZXQgdmYgbnVtYmVyClBPUlQ9JHsxIyMqZn0KUE9SVF9OQU1FPSQxCgojIG5lZWQgdGhlIFBBVEggZm9yIEJGIEFSTSBsc3BjaSB0byB3b3JrClBBVEg9L2Jpbjovc2JpbjovdXNyL2JpbjovdXNyL3NiaW4KCmlzX2JmPWBsc3BjaSAtcyAwMDowMC4wIDI+IC9kZXYvbnVsbCB8IGdyZXAgLXdxICJQQ0kgYnJpZGdlOiBNZWxsYW5veCBUZWNobm9sb2dpZXMiICYmIGVjaG8gMSB8fCBlY2hvIDBgCmlmIFsgJGlzX2JmIC1lcSAxIF07IHRoZW4KCWVjaG8gTkFNRT1gZWNobyAkezF9IHwgc2VkIC1lICJzL1wocGZbWzpkaWdpdDpdXVwrXCkkL1wxaHBmLyJgCglleGl0IDAKZmkKCiMgZm9yIHBmIGFuZCB1cGxpbmsgcmVwIGZhbGwgdG8gc2xvdCBvciBwYXRoLgppZiBbIC1uICIkSURfTkVUX05BTUVfU0xPVCIgXTsgdGhlbgogICAgZWNobyBOQU1FPSIke0lEX05FVF9OQU1FX1NMT1QlJW5wW1s6ZGlnaXQ6XV19IgogICAgZXhpdApmaQoKaWYgWyAtbiAiJElEX05FVF9OQU1FX1BBVEgiIF07IHRoZW4KICAgIGVjaG8gTkFNRT0iJHtJRF9ORVRfTkFNRV9QQVRIJSVucFtbOmRpZ2l0Ol1dfSIKICAgIGV4aXQKZmkKCmlmIFsgLXogIiRTV0lEIiBdOyB0aGVuCiAgICBleGl0IDAKZmkKCiMgZm9yIFNGIG1kZXYgZGV2aWNlcwpmdW5jdGlvbiBnZXRfc2ZfcmVwX25hbWUoKSB7CiAgICBiPWB1ZGV2YWRtIGluZm8gLXEgcHJvcGVydHkgLXAgL3N5cy9idXMvcGNpL2RldmljZXMvJDEvbmV0LyogfCBncmVwICJJRF9QQVRIPSIgfCBjdXQgLWQtIC1mMiB8IGN1dCAtZDogLWYyYAogICAgZD1gdWRldmFkbSBpbmZvIC1xIHByb3BlcnR5IC1wIC9zeXMvYnVzL3BjaS9kZXZpY2VzLyQxL25ldC8qIHwgZ3JlcCAiSURfUEFUSD0iIHwgY3V0IC1kLSAtZjIgfCBjdXQgLWQ6IC1mMyB8IGN1dCAtZC4gLWYxYAogICAgZj1gdWRldmFkbSBpbmZvIC1xIHByb3BlcnR5IC1wIC9zeXMvYnVzL3BjaS9kZXZpY2VzLyQxL25ldC8qIHwgZ3JlcCAiSURfUEFUSD0iIHwgY3V0IC1kLSAtZjIgfCBjdXQgLWQ6IC1mMyB8IGN1dCAtZC4gLWYyYAogICAgZWNobyAke2J9XyR7ZH1fJHtmfV8ke1BPUlRfTkFNRSMjKnB9Cn0KCiMgZ2V0IHBoeXNfc3dpdGNoX2lkIGJ5IG1kZXYKZnVuY3Rpb24gZ2V0X21kZXZfc3dpZCgpIHsKICAgIHJlcF9uYW1lPWBjYXQgL3N5cy9idXMvbWRldi9kZXZpY2VzLyQxL2RldmxpbmstY29tcGF0LWNvbmZpZy9uZXRkZXYgMj4vZGV2L251bGxgCiAgICBjYXQgL3N5cy9jbGFzcy9uZXQvJHtyZXBfbmFtZX0vcGh5c19zd2l0Y2hfaWQgMj4vZGV2L251bGwKfQoKIyBnZXQgcGh5c19wb3J0X25hbWUgYnkgbWRldgpmdW5jdGlvbiBnZXRfbWRldl9wb3J0X25hbWUoKSB7CiAgICByZXBfbmFtZT1gY2F0IC9zeXMvYnVzL21kZXYvZGV2aWNlcy8kMS9kZXZsaW5rLWNvbXBhdC1jb25maWcvbmV0ZGV2IDI+L2Rldi9udWxsYAogICAgY2F0IC9zeXMvY2xhc3MvbmV0LyR7cmVwX25hbWV9L3BoeXNfcG9ydF9uYW1lIDI+L2Rldi9udWxsCn0KCiMgdHJ5IGF0IG1vc3QgdHdvIHRpbWVzCmZvciBjbnQgaW4gezEuLjJ9OyBkbwogICAgIyB3YWl0IGZvciBtZGV2IHRvIGJlIGNyZWF0ZWQKICAgIHNsZWVwIDAuNQogICAgZm9yIGRldiBpbiBgbHMgLWwgL3N5cy9jbGFzcy9uZXQvKi9kZXZpY2UgfCBjdXQgLWQgIi8iIC1mOS1gOyBkbwogICAgICAgIGlmIFsgLWggL3N5cy9idXMvbWRldi9kZXZpY2VzLyR7ZGV2fSBdOyB0aGVuCiAgICAgICAgICAgIGZvciBwY2kgaW4gYGxzIC9zeXMvYnVzL3BjaS9kZXZpY2VzLypgOyBkbwogICAgICAgICAgICAgICAgIyBzZWFyY2hpbmcgZm9yIHBjaSBkZXYgdGhhdCBvd25zIHRoaXMgbWRldgogICAgICAgICAgICAgICAgaWYgWyAtYSAvc3lzL2J1cy9wY2kvZGV2aWNlcy8ke3BjaX0vJHtkZXZ9IF07IHRoZW4KICAgICAgICAgICAgICAgICAgICBfc3dpZD1gZ2V0X21kZXZfc3dpZCAkZGV2YAogICAgICAgICAgICAgICAgICAgIF9wb3J0bmFtZT1gZ2V0X21kZXZfcG9ydF9uYW1lICRkZXZgCiAgICAgICAgICAgICAgICAgICAgaWYgWyAiJF9zd2lkIiA9ICIkU1dJRCIgXSAmJiBbICIkX3BvcnRuYW1lIiA9ICIkUE9SVF9OQU1FIiBdCiAgICAgICAgICAgICAgICAgICAgdGhlbgogICAgICAgICAgICAgICAgICAgICAgICBlY2hvICJOQU1FPWBnZXRfc2ZfcmVwX25hbWUgJHBjaWAiCiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXQKICAgICAgICAgICAgICAgICAgICBmaQogICAgICAgICAgICAgICAgZmkKICAgICAgICAgICAgZG9uZQogICAgICAgIGZpCiAgICBkb25lCmRvbmUKCiMgZm9yIFZGcwpmdW5jdGlvbiBnZXRfcGNpX25hbWUoKSB7CiAgICBsb2NhbCBhPWB1ZGV2YWRtIGluZm8gLXEgcHJvcGVydHkgLXAgL3N5cy9idXMvcGNpL2RldmljZXMvJDEvbmV0LyogfCBncmVwICQyIHwgY3V0IC1kPSAtZjJgCiAgICBlY2hvICR7YSUlbnBbWzpkaWdpdDpdXX0KfQoKIyBnZXQgcGh5c19zd2l0Y2hfaWQgYnkgcGNpCmZ1bmN0aW9uIGdldF9wY2lfc3dpZCgpIHsKICAgIGNhdCAvc3lzL2J1cy9wY2kvZGV2aWNlcy8kMS9uZXQvKi9waHlzX3N3aXRjaF9pZCAyPi9kZXYvbnVsbAp9CgojIGdldCBwaHlzX3BvcnRfbmFtZSBieSBwY2kKZnVuY3Rpb24gZ2V0X3BjaV9wb3J0X25hbWUoKSB7CiAgICBjYXQgL3N5cy9idXMvcGNpL2RldmljZXMvJDEvbmV0LyovcGh5c19wb3J0X25hbWUgMj4vZGV2L251bGwKfQoKIyBmb3IgdmYgcmVwIGdldCBwYXJlbnQgc2xvdC9wYXRoLgpwYXJlbnRfcGh5c19wb3J0X25hbWU9JHtQT1JUX05BTUUldmYqfQpwYXJlbnRfcGh5c19wb3J0X25hbWU9JHtwYXJlbnRfcGh5c19wb3J0X25hbWUvL3BmfQooKHBhcmVudF9waHlzX3BvcnRfbmFtZSY9MHg3KSkKcGFyZW50X3BoeXNfcG9ydF9uYW1lPSJwJHBhcmVudF9waHlzX3BvcnRfbmFtZSIKIyB0cnkgYXQgbW9zdCB0d28gdGltZXMKZm9yIGNudCBpbiB7MS4uMn07IGRvCiAgICBmb3IgcGNpIGluIGBscyAtbCAvc3lzL2NsYXNzL25ldC8qL2RldmljZSB8IGN1dCAtZCAiLyIgLWY5LWA7IGRvCiAgICAgICAgaWYgWyAtaCAvc3lzL2J1cy9wY2kvZGV2aWNlcy8ke3BjaX0vcGh5c2ZuIF07IHRoZW4KICAgICAgICAgICAgY29udGludWUKICAgICAgICBmaQogICAgICAgIF9zd2lkPWBnZXRfcGNpX3N3aWQgJHBjaWAKICAgICAgICBfcG9ydG5hbWU9YGdldF9wY2lfcG9ydF9uYW1lICRwY2lgCiAgICAgICAgaWYgWyAteiAkX3BvcnRuYW1lIF07IHRoZW4KICAgICAgICAgICAgIyBubyB1cGxpbmsgcmVwIHNvIG5vIHBoeXMgcG9ydCBuYW1lCiAgICAgICAgICAgIF9wb3J0bmFtZT0kcGFyZW50X3BoeXNfcG9ydF9uYW1lCiAgICAgICAgZmkKICAgICAgICBpZiBbICIkX3N3aWQiID0gIiRTV0lEIiBdICYmIFsgIiRfcG9ydG5hbWUiID0gIiRwYXJlbnRfcGh5c19wb3J0X25hbWUiIF0KICAgICAgICB0aGVuCiAgICAgICAgICAgIHBhcmVudF9wYXRoPWBnZXRfcGNpX25hbWUgJHBjaSBJRF9ORVRfTkFNRV9TTE9UYAogICAgICAgICAgICBpZiBbIC16ICIkcGFyZW50X3BhdGgiIF07IHRoZW4KICAgICAgICAgICAgICAgIHBhcmVudF9wYXRoPWBnZXRfcGNpX25hbWUgJHBjaSBJRF9ORVRfTkFNRV9QQVRIYAogICAgICAgICAgICBmaQogICAgICAgICAgICBlY2hvICJOQU1FPSR7cGFyZW50X3BhdGh9XyRQT1JUIgogICAgICAgICAgICBleGl0CiAgICAgICAgZmkKICAgIGRvbmUKCiAgICAjIHN3aWQgY2hhbmdlcyB3aGVuIGVudGVyaW5nIGxhZyBtb2RlLgogICAgIyBTbyBpZiB3ZSBkaWRuJ3QgZmluZCBjdXJyZW50IHN3aWQsIGdldCB0aGUgdXBkYXRlZCBvbmUuCiAgICBTV0lEPWBjYXQgL3N5cy9jbGFzcy9uZXQvJElOVEVSRkFDRS9waHlzX3N3aXRjaF9pZGAKZG9uZQo=
        mode: 0755
        overwrite: true
        path: /etc/udev/vf-net-link-name.sh
      - contents:
          source: data:text/plain;charset=utf-8;base64,eyJpbnRlcmZhY2VzIjpbeyJwY2lBZGRyZXNzIjoiMDAwMDowMzowMC4wIiwibmFtZSI6ImVucDNzMGYwIiwiZVN3aXRjaE1vZGUiOiJzd2l0Y2hkZXYifV19Cg==
        mode: 0420
        overwrite: true
        path: /etc/sriov_config.json
      - contents:
          source: data:text/plain;charset=utf-8;base64,U1VCU1lTVEVNPT0ibmV0IiwgQUNUSU9OPT0iYWRkIiwgQVRUUntwaHlzX3N3aXRjaF9pZH0hPSIiLCBBVFRSe3BoeXNfcG9ydF9uYW1lfSE9IiIsIFwKICAgICAgICBJTVBPUlR7cHJvZ3JhbX09Ii9ldGMvdWRldi92Zi1uZXQtbGluay1uYW1lLnNoICRhdHRye3BoeXNfcG9ydF9uYW1lfSAkYXR0cntwaHlzX3N3aXRjaF9pZH0iIFwKICAgICAgICBOQU1FPSIkZW52e05BTUV9IiwgUlVOKz0iL3NiaW4vZXRodG9vbCAtTCAkZW52e05BTUV9IGNvbWJpbmVkIDQiLCBHT1RPPSJuZXRfc2V0dXBfc2tpcF9saW5rX25hbWUiCgoKU1VCU1lTVEVNPT0ibmV0IiwgQUNUSU9OPT0iYWRkIiwgQVRUUntwaHlzX3BvcnRfbmFtZX0hPSIiLCBcCiAgICAgICAgSU1QT1JUe3Byb2dyYW19PSIvZXRjL3VkZXYvdmYtbmV0LWxpbmstbmFtZS5zaCAkYXR0cntwaHlzX3BvcnRfbmFtZX0iIFwKICAgICAgICBOQU1FPSIkZW52e05BTUV9IiwgUlVOKz0iL3NiaW4vZXRodG9vbCAtTCAkZW52e05BTUV9IGNvbWJpbmVkIDQiCgpMQUJFTD0ibmV0X3NldHVwX3NraXBfbGlua19uYW1lIgo=
        mode: 0644
        overwrite: true
        path: /etc/udev/rules.d/82-net-setup-link.rules
    systemd:
      units:
      - dropins:
        - contents: |
            [Unit]
            Wants=switchdev-configuration.service
            After=switchdev-configuration.service
          name: 10-switchdev.conf
        name: NetworkManager.service
      - dropins:
        - contents: |
            [Service]
            ExecStartPre=/bin/ovs-vsctl set Open_vSwitch . other_config:hw-offload=false
            ExecStartPost=/bin/ovs-vsctl --may-exist add-port br-ex c1pf0hpf
          name: 10-hw-offload.conf
        name: ovs-vswitchd.service
      - contents: |
          [Unit]
          Description=Configures SRIOV NIC into switchdev mode
          # Removal of this file signals firstboot completion
          ConditionPathExists=!/etc/ignition-machine-config-encapsulated.json
          # This service is used to move a SRIOV NIC into switchdev mode
          Wants=network-pre.target
          Before=network-pre.target

          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/configure-switchdev.sh
          StandardOutput=journal+console
          StandardError=journal+console

          [Install]
          WantedBy=network-online.target
        enabled: true
        name: switchdev-configuration.service
